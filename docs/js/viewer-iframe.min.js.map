{"version":3,"sources":["viewer-iframe.js"],"names":["window","NS","calcHash","str","asHex","h","i","length","charCodeAt","hex","toString","substring","cache","Map","setClass","tar","cls","enabled","val","key","substr","startsWith","dataset","c","join","classList","add","remove","resizeListeners","onResize","fn","doFirst","push","isRunning","args","requestAnimationFrame","throttle","checkHash","is","hashPrefix","hash","location","indexOf","replace","id","inst","currentId","doClose","get","doOpen","document","addEventListener","l","passive","applyIframe","os","ifms","opts","Object","assign","styleOpener","styleOpenerWrapper","fs","map","o","has","n","set","calcHashSet","src","frameInst","frame","ifm","styleIframeFrame","styleLoaded","url","URL","ps","URLSearchParams","search","append","filterSource","removeAttribute","setAttribute","style","aspectRatio","w","f","parseInt","width","height","sW","sH","extractIframeSize","scale","realScale","baseSize","isLs","margin","frm","createElement","e","stopPropagation","appendChild","hasAttribute","opacity","setTimeout","contentDocument","setSource","contentWindow","postMessage","pause","createIframeFrame","assignIframeOpenerStyle","opener","caption","styleRoot","styleCloser","stylePrev","styleNext","styleCaption","styleOpen","styleVisible","styleInstantly","prev","createViewer","_onOpen","values","fi","doResize","altKey","ctrlKey","shiftKey","cur","dlg","click","btnPrev","btnNext","assignEventHandler","state","undefined","processHash","initialize","prevInstance","preventDefault","history","back","_onClose","btn","divCap","innerHTML","body","display","next","_setNextInstance","_setAdjacentInstance","instantly","replaceState","sty","getComputedStyle","documentElement","marginTop","top","newUrl","href","pushState","name"],"mappings":"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","file":"viewer-iframe.min.js","sourcesContent":["/**\n *\n * Viewer\n *\n * @author Takuto Yanagida\n * @version 2021-12-26\n *\n */\n\n\nwindow['NACSS']           = window['NACSS']           || {};\nwindow['NACSS']['viewer'] = window['NACSS']['viewer'] || {};\n\n\n((NS) => {\n\n\t/**\n\t *\n\t * Functions for Hash\n\t *\n\t * @author Takuto Yanagida\n\t * @version 2022-08-17\n\t *\n\t */\n\t\n\t\n\tfunction calcHash(str, asHex = true) {\n\t\tlet h = 0x811c9dc5;\n\t\tfor (let i = 0; i < str.length; i += 1) {\n\t\t\th ^= str.charCodeAt(i);\n\t\t\th += (h << 1) + (h << 4) + (h << 7) + (h << 8) + (h << 24);\n\t\t}\n\t\tif (asHex) {\n\t\t\tconst hex = '0000000' + (h >>> 0).toString(16);\n\t\t\treturn hex.substring(hex.length - 8);\n\t\t}\n\t\treturn h >>> 0;\n\t}\n\t\n\tconst cache = new Map();\n\t\n\tfunction calcHashSet(str, asHex = true) {\n\t\tif (cache.has(str)) {\n\t\t\tconst n = cache.get(str);\n\t\t\tcache.set(str, n + 1);\n\t\t\treturn calcHash(str + n, asHex);\n\t\t} else {\n\t\t\tcache.set(str, 1);\n\t\t\treturn calcHash(str, asHex);\n\t\t}\n\t}\n\t\n\t/**\n\t *\n\t * Style Class Utilities\n\t *\n\t * @author Takuto Yanagida\n\t * @version 2021-11-11\n\t *\n\t */\n\t\n\t\n\tfunction hasClass(tar, cls) {\n\t\tconst key = cls.substr(1);\n\t\tif (cls.startsWith(':')) {\n\t\t\treturn tar.dataset[key] !== undefined;\n\t\t} else {\n\t\t\treturn tar.classList.contains(key);\n\t\t}\n\t}\n\t\n\tfunction setClass(tar, cls, enabled = true, val = '') {\n\t\tconst key = cls.substr(1);\n\t\tif (cls.startsWith(':')) {\n\t\t\tif (enabled) {\n\t\t\t\ttar.dataset[key] = val;\n\t\t\t} else {\n\t\t\t\tdelete tar.dataset[key];\n\t\t\t}\n\t\t} else {\n\t\t\tconst c = [key, val].join('-');\n\t\t\tif (enabled) {\n\t\t\t\ttar.classList.add(c);\n\t\t\t} else {\n\t\t\t\ttar.classList.remove(c);\n\t\t\t}\n\t\t}\n\t}\n\t\n\tfunction getSelector(cls) {\n\t\tif (cls.startsWith(':')) {\n\t\t\treturn `*[data-${cls.substr(1).replace(/([A-Z])/g, c => '-' + c.charAt(0).toLowerCase())}]`;\n\t\t} else {\n\t\t\treturn `*${cls}`;\n\t\t}\n\t}\n\t\n\t/**\n\t *\n\t * Utilities\n\t *\n\t * @author Takuto Yanagida\n\t * @version 2021-12-06\n\t *\n\t */\n\t\n\t\n\tfunction getScrollOffset() {\n\t\tconst s   = getComputedStyle(document.documentElement);\n\t\tconst val = parseInt(s.scrollPaddingTop);\n\t\treturn Number.isNaN(val) ? 0 : val;\n\t}\n\t\n\t\n\t// -----------------------------------------------------------------------------\n\t\n\t\n\tfunction throttle(fn) {\n\t\tlet isRunning;\n\t\treturn (...args) => {\n\t\t\tif (isRunning) return;\n\t\t\tisRunning = true;\n\t\t\trequestAnimationFrame(() => {\n\t\t\t\tisRunning = false;\n\t\t\t\tfn(...args);\n\t\t\t});\n\t\t};\n\t}\n\t\n\tconst resizeListeners = [];\n\t\n\tfunction onResize(fn, doFirst = false) {\n\t\tif (doFirst) fn();\n\t\tresizeListeners.push(throttle(fn));\n\t}\n\t\n\tdocument.addEventListener('DOMContentLoaded', () => {\n\t\twindow.addEventListener('resize', () => {\n\t\t\tfor (const l of resizeListeners) l();\n\t\t}, { passive: true });\n\t});\n\t\n\n\t/**\n\t *\n\t * Iframe Viewer\n\t *\n\t * @author Takuto Yanagida\n\t * @version 2022-08-17\n\t *\n\t */\n\t\n\t\n\tfunction apply(os, ifms, opts = {}) {\n\t\tif (os.length === 0) return;\n\t\n\t\topts = Object.assign({\n\t\t\tstyleOpener       : ':ncViewerOpener',\n\t\t\tstyleOpenerWrapper: ':ncViewerOpenerWrapper',\n\t\t}, opts);\n\t\n\t\tconst fs = os.map((o, i) => {\n\t\t\tconst id = calcHashSet(ifms[i].src);\n\t\t\tconst [frameInst, frame] = createIframeFrame(opts, ifms[i]);\n\t\t\tassignIframeOpenerStyle(o, opts['styleOpener']);\n\t\n\t\t\treturn { opener: o, id, frameInst, frame, caption: null };\n\t\t});\n\t\tinitialize(fs, opts);\n\t}\n\t\n\t\n\t// -----------------------------------------------------------------------------\n\t\n\t\n\tfunction createIframeFrame(opts, ifm) {\n\t\topts = Object.assign({\n\t\t\tstyleIframeFrame: ':ncFrameIframe',\n\t\t\tstyleLoaded     : ':ncLoaded',\n\t\t}, opts);\n\t\n\t\tconst src = filterSource(ifm.src);\n\t\n\t\tifm.removeAttribute('src');\n\t\tifm.setAttribute('data-nc-lazy', '');\n\t\tif (!ifm.style.aspectRatio) {\n\t\t\tconst [w, h] = extractIframeSize(ifm);\n\t\t\tif (w && h) {\n\t\t\t\tifm.style.aspectRatio = `${w} / ${h}`;\n\t\t\t}\n\t\t}\n\t\n\t\tconst inst = {\n\t\t\topts, src, ifm,\n\t\n\t\t\tscale    : 1,\n\t\t\trealScale: 1,\n\t\t\tbaseSize : null,\n\t\t\tisLs     : false,\n\t\t\tmargin   : 0,\n\t\n\t\t\tfrm: null,\n\t\t};\n\t\n\t\tinst.frm = document.createElement('div');\n\t\tsetClass(inst.frm, inst.opts.styleIframeFrame);\n\t\n\t\tinst.ifm.addEventListener('click', e => e.stopPropagation());\n\t\tinst.frm.appendChild(inst.ifm);\n\t\n\t\tinst['doResize'] = () => {};\n\t\tinst['doOpen']   = () => setSource(inst);\n\t\tinst['doClose']  = () => pause(inst);\n\t\treturn [inst, inst.frm];\n\t}\n\t\n\tfunction assignIframeOpenerStyle(o, styleOpener) {\n\t\tsetClass(o, styleOpener);\n\t}\n\t\n\t\n\t// -----------------------------------------------------------------------------\n\t\n\t\n\tfunction setSource(inst) {\n\t\tconst ifm = inst.ifm;\n\t\tif (ifm.hasAttribute('data-nc-lazy')) {\n\t\t\tifm.removeAttribute('data-nc-lazy');\n\t\t\tifm.style.opacity = '0';\n\t\t\tifm.addEventListener('load', () => {\n\t\t\t\tsetClass(inst.frm, inst.opts.styleLoaded);\n\t\t\t\tsetTimeout(() => { ifm.style.opacity = '1'; }, 0);\n\t\t\t});\n\t\t\tifm.contentDocument.location.replace(inst.src);\n\t\t}\n\t}\n\t\n\tfunction pause(inst) {\n\t\tif (inst.src.startsWith('https://www.youtube.com')) {\n\t\t\tinst.ifm.contentWindow.postMessage('{\"event\":\"command\",\"func\":\"pauseVideo\",\"args\":\"\"}', '*');\n\t\t}\n\t}\n\t\n\t\n\t// -----------------------------------------------------------------------------\n\t\n\t\n\tfunction filterSource(src) {\n\t\tif (src.startsWith('https://www.youtube.com')) {\n\t\t\tconst url = new URL(src);\n\t\t\tconst ps  = new URLSearchParams(url.search);\n\t\t\tps.append('enablejsapi', 1);\n\t\t\turl.search = ps;\n\t\t\tsrc = url.toString();\n\t\t}\n\t\treturn src;\n\t}\n\t\n\tfunction extractIframeSize(f) {\n\t\tlet w = parseInt(f.width);\n\t\tlet h = parseInt(f.height);\n\t\tif (w && h) return [w, h];\n\t\n\t\tconst sW = f.style.width;\n\t\tconst sH = f.style.height;\n\t\tif (sW.indexOf('px') !== sW.length - 2) return [0, 0];\n\t\tif (sH.indexOf('px') !== sH.length - 2) return [0, 0];\n\t\tw = parseInt(sW);\n\t\th = parseInt(sH);\n\t\tif (w && h) return [w, h];\n\t\treturn [0, 0];\n\t}\n\t\n\tNS.applyIframe = apply;\n\n\t/**\n\t *\n\t * Dialog\n\t *\n\t * @author Takuto Yanagida\n\t * @version 2022-08-17\n\t *\n\t */\n\t\n\t\n\tfunction initialize(fs, opts = {}) {\n\t\tif (fs.length === 0) return;\n\t\n\t\topts = Object.assign({\n\t\t\tstyleRoot   : ':ncViewer',\n\t\t\tstyleCloser : ':ncViewerCloser',\n\t\t\tstylePrev   : ':ncViewerPrev',\n\t\t\tstyleNext   : ':ncViewerNext',\n\t\t\tstyleCaption: ':ncViewerCaption',\n\t\n\t\t\tstyleOpen     : ':ncOpen',\n\t\t\tstyleVisible  : ':ncVisible',\n\t\t\tstyleInstantly: ':ncInstantly',\n\t\n\t\t\thashPrefix: 'viewer:',\n\t\t}, opts);\n\t\n\t\tconst is = new Map();\n\t\tlet prev = null;\n\t\tfor (const f of fs) {\n\t\t\tconst inst = createViewer(opts, f.id, f.frameInst, f.frame, f.caption, prev);\n\t\t\tf.opener.addEventListener('click', e => _onOpen(inst, e));\n\t\t\tis.set(f.id, inst);\n\t\t\tprev = inst;\n\t\t}\n\t\tassignEventHandler(is);\n\t\tprocessHash(is, opts['hashPrefix']);\n\t}\n\t\n\tfunction assignEventHandler(is) {\n\t\tonResize(() => {\n\t\t\tfor (const inst of is.values()) inst.fi.doResize();\n\t\t\tsetTimeout(() => {\n\t\t\t\tfor (const inst of is.values()) inst.fi.doResize();\n\t\t\t}, 200);\n\t\t});\n\t\twindow.addEventListener('keydown', e => {\n\t\t\tif (currentId !== null && !e.altKey && !e.ctrlKey && !e.shiftKey) {\n\t\t\t\tconst cur = is.get(currentId);\n\t\t\t\tif (e.key === 'Escape') cur.dlg.click();\n\t\t\t\telse if (e.key === 'ArrowLeft') cur.btnPrev.click();\n\t\t\t\telse if (e.key === 'ArrowRight') cur.btnNext.click();\n\t\t\t}\n\t\t});\n\t}\n\t\n\tfunction processHash(is, hashPrefix) {\n\t\twindow.addEventListener('popstate', e => {\n\t\t\tif (currentId !== null && is.has(currentId)) {\n\t\t\t\tdoClose(is.get(currentId));\n\t\t\t}\n\t\t\tif (e.state && e.state['name'] === 'nc-viewer' && e.state['id'] !== undefined && is.has(e.state['id'])) {\n\t\t\t\tdoOpen(is.get(e.state['id']));\n\t\t\t}\n\t\t});\n\t\twindow.addEventListener('hashchange', () => checkHash(is, hashPrefix, location.hash));\n\t\tcheckHash(is, hashPrefix, location.hash);\n\t}\n\t\n\tfunction checkHash(is, hashPrefix, hash) {\n\t\tif (location.hash.indexOf('#' + hashPrefix) !== 0) return;\n\t\tconst h = hash.replace('#' + hashPrefix, '');\n\t\tif (!h) return;\n\t\tfor (const [id, inst] of is) {\n\t\t\tif (id === h) {\n\t\t\t\tif (currentId !== null && currentId !== id) doClose(is.get(currentId));\n\t\t\t\tif (currentId === null || currentId !== id) doOpen(inst);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t}\n\t\n\t\n\t// -----------------------------------------------------------------------------\n\t\n\t\n\tlet currentId = null;\n\t\n\tfunction createViewer(opts, id, frameInst, frame, caption, prevInstance = null) {\n\t\tconst inst = {};\n\t\tinst.opts = opts;\n\t\tinst.fi   = frameInst;\n\t\tinst.id   = id;\n\t\n\t\tinst.dlg = document.createElement('div');\n\t\tsetClass(inst.dlg, opts.styleRoot);\n\t\tinst.dlg.addEventListener('click', e => _onClose(e));\n\t\tinst.dlg.appendChild(frame);\n\t\n\t\tconst btn = document.createElement('button');\n\t\tsetClass(btn, opts.styleCloser);\n\t\tinst.dlg.appendChild(btn);\n\t\n\t\tinst.btnPrev = document.createElement('button');\n\t\tinst.btnNext = document.createElement('button');\n\t\tsetClass(inst.btnPrev, opts.stylePrev);\n\t\tsetClass(inst.btnNext, opts.styleNext);\n\t\tinst.dlg.appendChild(inst.btnPrev);\n\t\tinst.dlg.appendChild(inst.btnNext);\n\t\n\t\tif (caption) {\n\t\t\tconst divCap = document.createElement('div');\n\t\t\tdivCap.innerHTML = `<span>${caption}</span>`;\n\t\t\tsetClass(divCap, opts.styleCaption);\n\t\t\tinst.dlg.appendChild(divCap);\n\t\t}\n\t\tdocument.body.appendChild(inst.dlg);\n\t\n\t\t_setAdjacentInstance(inst, prevInstance);\n\t\tprevInstance = inst;\n\t\treturn inst;\n\t}\n\t\n\t\n\t// -----------------------------------------------------------------------------\n\t\n\t\n\tfunction doOpen(inst, instantly = false) {\n\t\tsetClass(inst.dlg, inst.opts.styleOpen);\n\t\tinst.fi.doOpen();\n\t\n\t\tif (instantly) {\n\t\t\tinst.fi.doResize();\n\t\t\tsetClass(inst.dlg, inst.opts.styleInstantly);\n\t\t\tsetClass(inst.dlg, inst.opts.styleVisible);\n\t\t\tsetTimeout(() => { setClass(inst.dlg, inst.opts.styleInstantly, false); }, 20);\n\t\n\t\t\tconst url = '#' + inst.opts.hashPrefix + inst.id;\n\t\t\thistory.replaceState(null, '', url);\n\t\t} else {\n\t\t\tsetTimeout(() => {\n\t\t\t\tinst.fi.doResize();\n\t\t\t\tsetClass(inst.dlg, inst.opts.styleVisible);\n\t\t\t}, 0);\n\t\t}\n\t\tcurrentId = inst.id;\n\t\n\t\tconst sty = getComputedStyle(document.documentElement);\n\t\tif (sty.marginTop) {\n\t\t\tinst.dlg.style.top = sty.marginTop;\n\t\t}\n\t}\n\t\n\tfunction doClose(inst, instantly = false) {\n\t\tinst.fi.doClose();\n\t\n\t\tif (instantly) {\n\t\t\tsetClass(inst.dlg, inst.opts.styleInstantly);\n\t\t\tsetClass(inst.dlg, inst.opts.styleVisible, false);\n\t\t\tsetTimeout(() => { setClass(inst.dlg, inst.opts.styleInstantly, false); }, 20);\n\t\t} else {\n\t\t\tsetClass(inst.dlg, inst.opts.styleVisible, false);\n\t\t}\n\t\tsetTimeout(() => { setClass(inst.dlg, inst.opts.styleOpen, false); }, 200);\n\t\tcurrentId = null;\n\t}\n\t\n\t\n\t// -----------------------------------------------------------------------------\n\t\n\t\n\tfunction _setAdjacentInstance(inst, prev) {\n\t\tinst.btnNext.style.display = 'none';\n\t\tif (prev) {\n\t\t\tinst.btnPrev.addEventListener('click', e => {\n\t\t\t\te.stopPropagation();\n\t\t\t\tdoClose(inst, true);\n\t\t\t\tdoOpen(prev, true);\n\t\t\t});\n\t\t\t_setNextInstance(prev, inst);\n\t\t} else {\n\t\t\tinst.btnPrev.style.display = 'none';\n\t\t}\n\t}\n\t\n\tfunction _setNextInstance(inst, next) {\n\t\tinst.btnNext.addEventListener('click', e => {\n\t\t\te.stopPropagation();\n\t\t\tdoClose(inst, true);\n\t\t\tdoOpen(next, true);\n\t\t});\n\t\tinst.btnNext.style.display = null;\n\t}\n\t\n\tfunction _onOpen(inst, e) {\n\t\te.preventDefault();\n\t\tdoOpen(inst);\n\t\n\t\tif (location.hash) {\n\t\t\tconst newUrl = location.href.substring(0, location.href.indexOf('#'));\n\t\t\thistory.replaceState(null, '', newUrl);\n\t\t}\n\t\tconst url = '#' + inst.opts.hashPrefix + inst.id;\n\t\thistory.pushState({ name: 'nc-viewer', id: inst.id }, null, url);\n\t}\n\t\n\tfunction _onClose(e) {\n\t\te.preventDefault();\n\t\thistory.back();\n\t}\n\t\n\n})(window['NACSS']['viewer']);\n"]}