{"version":3,"sources":["viewer-iframe.js"],"names":["window","NS","calcHash","str","asHex","h","i","length","charCodeAt","hex","toString","substring","cache","Map","setClass","tar","cls","enabled","val","key","substr","startsWith","dataset","c","join","classList","add","remove","resizeListeners","onResize","fn","doFirst","push","isRunning","args","requestAnimationFrame","throttle","checkHash","is","hashPrefix","hash","location","indexOf","replace","id","inst","currentId","doClose","get","doOpen","document","addEventListener","l","passive","applyIframe","os","ifms","opts","Object","assign","styleOpener","styleOpenerWrapper","fs","styleRoot","styleCloser","stylePrev","styleNext","styleCaption","styleOpen","styleVisible","styleInstantly","prev","f","createViewer","frameInst","frame","caption","opener","e","_onOpen","set","values","fi","doResize","setTimeout","altKey","ctrlKey","shiftKey","cur","dlg","click","btnPrev","btnNext","assignEventHandler","has","state","undefined","processHash","initialize","map","o","n","calcHashSet","src","ifm","styleIframeFrame","styleLoaded","url","URL","ps","URLSearchParams","search","append","filterSource","removeAttribute","setAttribute","style","aspectRatio","w","parseInt","width","height","sW","sH","extractIframeSize","scale","realScale","baseSize","isLs","margin","frm","createElement","stopPropagation","appendChild","hasAttribute","opacity","contentDocument","setSource","contentWindow","postMessage","pause","createIframeFrame","assignIframeOpenerStyle","prevInstance","preventDefault","history","back","_onClose","btn","divCap","innerHTML","body","display","next","_setNextInstance","_setAdjacentInstance","instantly","replaceState","sty","getComputedStyle","documentElement","marginTop","top","newUrl","href","pushState","name"],"mappings":"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","file":"viewer-iframe.min.js","sourcesContent":["/**\n *\n * Viewer\n *\n * @author Takuto Yanagida\n * @version 2021-12-26\n *\n */\n\n\nwindow['NACSS']           = window['NACSS']           || {};\nwindow['NACSS']['viewer'] = window['NACSS']['viewer'] || {};\n\n\n((NS) => {\n\n\t/**\n\t *\n\t * Functions for Hash\n\t *\n\t * @author Takuto Yanagida\n\t * @version 2022-08-17\n\t *\n\t */\n\t\n\t\n\tfunction calcHash(str, asHex = true) {\n\t\tlet h = 0x811c9dc5;\n\t\tfor (let i = 0; i < str.length; i += 1) {\n\t\t\th ^= str.charCodeAt(i);\n\t\t\th += (h << 1) + (h << 4) + (h << 7) + (h << 8) + (h << 24);\n\t\t}\n\t\tif (asHex) {\n\t\t\tconst hex = '0000000' + (h >>> 0).toString(16);\n\t\t\treturn hex.substring(hex.length - 8);\n\t\t}\n\t\treturn h >>> 0;\n\t}\n\t\n\tconst cache = new Map();\n\t\n\tfunction calcHashSet(str, asHex = true) {\n\t\tif (cache.has(str)) {\n\t\t\tconst n = cache.get(str);\n\t\t\tcache.set(str, n + 1);\n\t\t\treturn calcHash(str + n, asHex);\n\t\t} else {\n\t\t\tcache.set(str, 1);\n\t\t\treturn calcHash(str, asHex);\n\t\t}\n\t}\n\t\n\t/**\n\t *\n\t * Style Class Utilities\n\t *\n\t * @author Takuto Yanagida\n\t * @version 2021-11-11\n\t *\n\t */\n\t\n\t\n\tfunction hasClass(tar, cls) {\n\t\tconst key = cls.substr(1);\n\t\tif (cls.startsWith(':')) {\n\t\t\treturn tar.dataset[key] !== undefined;\n\t\t} else {\n\t\t\treturn tar.classList.contains(key);\n\t\t}\n\t}\n\t\n\tfunction setClass(tar, cls, enabled = true, val = '') {\n\t\tconst key = cls.substr(1);\n\t\tif (cls.startsWith(':')) {\n\t\t\tif (enabled) {\n\t\t\t\ttar.dataset[key] = val;\n\t\t\t} else {\n\t\t\t\tdelete tar.dataset[key];\n\t\t\t}\n\t\t} else {\n\t\t\tconst c = [key, val].join('-');\n\t\t\tif (enabled) {\n\t\t\t\ttar.classList.add(c);\n\t\t\t} else {\n\t\t\t\ttar.classList.remove(c);\n\t\t\t}\n\t\t}\n\t}\n\t\n\tfunction getSelector(cls) {\n\t\tif (cls.startsWith(':')) {\n\t\t\treturn `*[data-${cls.substr(1).replace(/([A-Z])/g, c => '-' + c.charAt(0).toLowerCase())}]`;\n\t\t} else {\n\t\t\treturn `*${cls}`;\n\t\t}\n\t}\n\t\n\t/**\n\t *\n\t * Utilities\n\t *\n\t * @author Takuto Yanagida\n\t * @version 2021-12-06\n\t *\n\t */\n\t\n\t\n\tfunction getScrollOffset() {\n\t\tconst s   = getComputedStyle(document.documentElement);\n\t\tconst val = parseInt(s.scrollPaddingTop);\n\t\treturn Number.isNaN(val) ? 0 : val;\n\t}\n\t\n\t\n\t// -----------------------------------------------------------------------------\n\t\n\t\n\tfunction throttle(fn) {\n\t\tlet isRunning;\n\t\treturn (...args) => {\n\t\t\tif (isRunning) return;\n\t\t\tisRunning = true;\n\t\t\trequestAnimationFrame(() => {\n\t\t\t\tisRunning = false;\n\t\t\t\tfn(...args);\n\t\t\t});\n\t\t};\n\t}\n\t\n\tconst resizeListeners = [];\n\t\n\tfunction onResize(fn, doFirst = false) {\n\t\tif (doFirst) fn();\n\t\tresizeListeners.push(throttle(fn));\n\t}\n\t\n\tdocument.addEventListener('DOMContentLoaded', () => {\n\t\twindow.addEventListener('resize', () => {\n\t\t\tfor (const l of resizeListeners) l();\n\t\t}, { passive: true });\n\t});\n\t\n\n\t/**\n\t *\n\t * Iframe Viewer\n\t *\n\t * @author Takuto Yanagida\n\t * @version 2022-08-17\n\t *\n\t */\n\t\n\t\n\tfunction apply(os, ifms, opts = {}) {\n\t\tif (os.length === 0) return;\n\t\n\t\topts = Object.assign({\n\t\t\tstyleOpener       : ':ncViewerOpener',\n\t\t\tstyleOpenerWrapper: ':ncViewerOpenerWrapper',\n\t\t}, opts);\n\t\n\t\tconst fs = os.map((o, i) => {\n\t\t\tconst id = calcHashSet(ifms[i].src);\n\t\t\tconst [frameInst, frame] = createIframeFrame(opts, ifms[i]);\n\t\t\tassignIframeOpenerStyle(o, opts['styleOpener']);\n\t\n\t\t\treturn { opener: o, id, frameInst, frame, caption: null };\n\t\t});\n\t\tinitialize(fs, opts);\n\t}\n\t\n\t\n\t// -----------------------------------------------------------------------------\n\t\n\t\n\tfunction createIframeFrame(opts, ifm) {\n\t\topts = Object.assign({\n\t\t\tstyleIframeFrame: ':ncFrameIframe',\n\t\t\tstyleLoaded     : ':ncLoaded',\n\t\t}, opts);\n\t\n\t\tconst src = filterSource(ifm.src);\n\t\n\t\tifm.removeAttribute('src');\n\t\tifm.setAttribute('data-nc-lazy', '');\n\t\tif (!ifm.style.aspectRatio) {\n\t\t\tconst [w, h] = extractIframeSize(ifm);\n\t\t\tif (w && h) {\n\t\t\t\tifm.style.aspectRatio = `${w} / ${h}`;\n\t\t\t}\n\t\t}\n\t\n\t\tconst inst = {\n\t\t\topts, src, ifm,\n\t\n\t\t\tscale    : 1,\n\t\t\trealScale: 1,\n\t\t\tbaseSize : null,\n\t\t\tisLs     : false,\n\t\t\tmargin   : 0,\n\t\n\t\t\tfrm: null,\n\t\t};\n\t\n\t\tinst.frm = document.createElement('div');\n\t\tsetClass(inst.frm, inst.opts.styleIframeFrame);\n\t\n\t\tinst.ifm.addEventListener('click', e => e.stopPropagation());\n\t\tinst.frm.appendChild(inst.ifm);\n\t\n\t\tinst['doResize'] = () => {};\n\t\tinst['doOpen']   = () => setSource(inst);\n\t\tinst['doClose']  = () => pause(inst);\n\t\treturn [inst, inst.frm];\n\t}\n\t\n\tfunction assignIframeOpenerStyle(o, styleOpener) {\n\t\tsetClass(o, styleOpener);\n\t}\n\t\n\t\n\t// -----------------------------------------------------------------------------\n\t\n\t\n\tfunction setSource(inst) {\n\t\tconst ifm = inst.ifm;\n\t\tif (ifm.hasAttribute('data-nc-lazy')) {\n\t\t\tifm.removeAttribute('data-nc-lazy');\n\t\t\tifm.style.opacity = '0';\n\t\t\tifm.addEventListener('load', () => {\n\t\t\t\tsetClass(inst.frm, inst.opts.styleLoaded);\n\t\t\t\tsetTimeout(() => { ifm.style.opacity = '1'; }, 0);\n\t\t\t});\n\t\t\tifm.contentDocument.location.replace(inst.src);\n\t\t}\n\t}\n\t\n\tfunction pause(inst) {\n\t\tif (inst.src.startsWith('https://www.youtube.com')) {\n\t\t\tinst.ifm.contentWindow.postMessage('{\"event\":\"command\",\"func\":\"pauseVideo\",\"args\":\"\"}', '*');\n\t\t}\n\t}\n\t\n\t\n\t// -----------------------------------------------------------------------------\n\t\n\t\n\tfunction filterSource(src) {\n\t\tif (src.startsWith('https://www.youtube.com')) {\n\t\t\tconst url = new URL(src);\n\t\t\tconst ps  = new URLSearchParams(url.search);\n\t\t\tps.append('enablejsapi', 1);\n\t\t\turl.search = ps;\n\t\t\tsrc = url.toString();\n\t\t}\n\t\treturn src;\n\t}\n\t\n\tfunction extractIframeSize(f) {\n\t\tlet w = parseInt(f.width);\n\t\tlet h = parseInt(f.height);\n\t\tif (w && h) return [w, h];\n\t\n\t\tconst sW = f.style.width;\n\t\tconst sH = f.style.height;\n\t\tif (sW.indexOf('px') !== sW.length - 2) return [0, 0];\n\t\tif (sH.indexOf('px') !== sH.length - 2) return [0, 0];\n\t\tw = parseInt(sW);\n\t\th = parseInt(sH);\n\t\tif (w && h) return [w, h];\n\t\treturn [0, 0];\n\t}\n\t\n\tNS.applyIframe = apply;\n\n\t/**\n\t *\n\t * Dialog\n\t *\n\t * @author Takuto Yanagida\n\t * @version 2022-08-17\n\t *\n\t */\n\t\n\t\n\tfunction initialize(fs, opts = {}) {\n\t\tif (fs.length === 0) return;\n\t\n\t\topts = Object.assign({\n\t\t\tstyleRoot   : ':ncViewer',\n\t\t\tstyleCloser : ':ncViewerCloser',\n\t\t\tstylePrev   : ':ncViewerPrev',\n\t\t\tstyleNext   : ':ncViewerNext',\n\t\t\tstyleCaption: ':ncViewerCaption',\n\t\n\t\t\tstyleOpen     : ':ncOpen',\n\t\t\tstyleVisible  : ':ncVisible',\n\t\t\tstyleInstantly: ':ncInstantly',\n\t\n\t\t\thashPrefix: 'viewer:',\n\t\t}, opts);\n\t\n\t\tconst is = new Map();\n\t\tlet prev = null;\n\t\tfor (const f of fs) {\n\t\t\tconst inst = createViewer(opts, f.id, f.frameInst, f.frame, f.caption, prev);\n\t\t\tf.opener.addEventListener('click', e => _onOpen(inst, e));\n\t\t\tis.set(f.id, inst);\n\t\t\tprev = inst;\n\t\t}\n\t\tassignEventHandler(is);\n\t\tprocessHash(is, opts['hashPrefix']);\n\t}\n\t\n\tfunction assignEventHandler(is) {\n\t\tonResize(() => {\n\t\t\tfor (const inst of is.values()) inst.fi.doResize();\n\t\t\tsetTimeout(() => {\n\t\t\t\tfor (const inst of is.values()) inst.fi.doResize();\n\t\t\t}, 200);\n\t\t});\n\t\twindow.addEventListener('keydown', e => {\n\t\t\tif (currentId !== null && !e.altKey && !e.ctrlKey && !e.shiftKey) {\n\t\t\t\tconst cur = is.get(currentId);\n\t\t\t\tif (e.key === 'Escape') cur.dlg.click();\n\t\t\t\telse if (e.key === 'ArrowLeft') cur.btnPrev.click();\n\t\t\t\telse if (e.key === 'ArrowRight') cur.btnNext.click();\n\t\t\t}\n\t\t});\n\t}\n\t\n\tfunction processHash(is, hashPrefix) {\n\t\twindow.addEventListener('popstate', e => {\n\t\t\tif (currentId !== null && is.has(currentId)) {\n\t\t\t\tdoClose(is.get(currentId));\n\t\t\t}\n\t\t\tif (e.state && e.state['name'] === 'nc-viewer' && e.state['id'] !== undefined && is.has(e.state['id'])) {\n\t\t\t\tdoOpen(is.get(e.state['id']));\n\t\t\t}\n\t\t});\n\t\twindow.addEventListener('hashchange', () => checkHash(is, hashPrefix, location.hash));\n\t\tcheckHash(is, hashPrefix, location.hash);\n\t}\n\t\n\tfunction checkHash(is, hashPrefix, hash) {\n\t\tif (location.hash.indexOf('#' + hashPrefix) !== 0) return;\n\t\tconst h = hash.replace('#' + hashPrefix, '');\n\t\tif (!h) return;\n\t\tfor (const [id, inst] of is) {\n\t\t\tif (id === h) {\n\t\t\t\tif (currentId !== null && currentId !== id) doClose(is.get(currentId));\n\t\t\t\tif (currentId === null || currentId !== id) doOpen(inst);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t}\n\t\n\t\n\t// -----------------------------------------------------------------------------\n\t\n\t\n\tlet currentId = null;\n\t\n\tfunction createViewer(opts, id, frameInst, frame, caption, prevInstance = null) {\n\t\tconst inst = {};\n\t\tinst.opts = opts;\n\t\tinst.fi   = frameInst;\n\t\tinst.id   = id;\n\t\n\t\tinst.dlg = document.createElement('div');\n\t\tsetClass(inst.dlg, opts.styleRoot);\n\t\tinst.dlg.addEventListener('click', e => _onClose(e));\n\t\tinst.dlg.appendChild(frame);\n\t\n\t\tconst btn = document.createElement('button');\n\t\tsetClass(btn, opts.styleCloser);\n\t\tinst.dlg.appendChild(btn);\n\t\n\t\tinst.btnPrev = document.createElement('button');\n\t\tinst.btnNext = document.createElement('button');\n\t\tsetClass(inst.btnPrev, opts.stylePrev);\n\t\tsetClass(inst.btnNext, opts.styleNext);\n\t\tinst.dlg.appendChild(inst.btnPrev);\n\t\tinst.dlg.appendChild(inst.btnNext);\n\t\n\t\tif (caption) {\n\t\t\tconst divCap = document.createElement('div');\n\t\t\tdivCap.innerHTML = `<span>${caption}</span>`;\n\t\t\tsetClass(divCap, opts.styleCaption);\n\t\t\tinst.dlg.appendChild(divCap);\n\t\t}\n\t\tdocument.body.appendChild(inst.dlg);\n\t\n\t\t_setAdjacentInstance(inst, prevInstance);\n\t\tprevInstance = inst;\n\t\treturn inst;\n\t}\n\t\n\t\n\t// -----------------------------------------------------------------------------\n\t\n\t\n\tfunction doOpen(inst, instantly = false) {\n\t\tsetClass(inst.dlg, inst.opts.styleOpen);\n\t\tinst.fi.doOpen();\n\t\n\t\tif (instantly) {\n\t\t\tinst.fi.doResize();\n\t\t\tsetClass(inst.dlg, inst.opts.styleInstantly);\n\t\t\tsetClass(inst.dlg, inst.opts.styleVisible);\n\t\t\tsetTimeout(() => { setClass(inst.dlg, inst.opts.styleInstantly, false); }, 20);\n\t\n\t\t\tconst url = '#' + inst.opts.hashPrefix + inst.id;\n\t\t\thistory.replaceState(null, '', url);\n\t\t} else {\n\t\t\tsetTimeout(() => {\n\t\t\t\tinst.fi.doResize();\n\t\t\t\tsetClass(inst.dlg, inst.opts.styleVisible);\n\t\t\t}, 0);\n\t\t}\n\t\tcurrentId = inst.id;\n\t\n\t\tconst sty = getComputedStyle(document.documentElement);\n\t\tif (sty.marginTop) {\n\t\t\tinst.dlg.style.top = sty.marginTop;\n\t\t}\n\t}\n\t\n\tfunction doClose(inst, instantly = false) {\n\t\tinst.fi.doClose();\n\t\n\t\tif (instantly) {\n\t\t\tsetClass(inst.dlg, inst.opts.styleInstantly);\n\t\t\tsetClass(inst.dlg, inst.opts.styleVisible, false);\n\t\t\tsetTimeout(() => { setClass(inst.dlg, inst.opts.styleInstantly, false); }, 20);\n\t\t} else {\n\t\t\tsetClass(inst.dlg, inst.opts.styleVisible, false);\n\t\t}\n\t\tsetTimeout(() => { setClass(inst.dlg, inst.opts.styleOpen, false); }, 200);\n\t\tcurrentId = null;\n\t}\n\t\n\t\n\t// -----------------------------------------------------------------------------\n\t\n\t\n\tfunction _setAdjacentInstance(inst, prev) {\n\t\tinst.btnNext.style.display = 'none';\n\t\tif (prev) {\n\t\t\tinst.btnPrev.addEventListener('click', e => {\n\t\t\t\te.stopPropagation();\n\t\t\t\tdoClose(inst, true);\n\t\t\t\tdoOpen(prev, true);\n\t\t\t});\n\t\t\t_setNextInstance(prev, inst);\n\t\t} else {\n\t\t\tinst.btnPrev.style.display = 'none';\n\t\t}\n\t}\n\t\n\tfunction _setNextInstance(inst, next) {\n\t\tinst.btnNext.addEventListener('click', e => {\n\t\t\te.stopPropagation();\n\t\t\tdoClose(inst, true);\n\t\t\tdoOpen(next, true);\n\t\t});\n\t\tinst.btnNext.style.display = null;\n\t}\n\t\n\tfunction _onOpen(inst, e) {\n\t\te.preventDefault();\n\t\tdoOpen(inst);\n\t\n\t\tif (location.hash) {\n\t\t\tconst newUrl = location.href.substring(0, location.href.indexOf('#'));\n\t\t\thistory.replaceState(null, '', newUrl);\n\t\t}\n\t\tconst url = '#' + inst.opts.hashPrefix + inst.id;\n\t\thistory.pushState({ name: 'nc-viewer', id: inst.id }, null, url);\n\t}\n\t\n\tfunction _onClose(e) {\n\t\te.preventDefault();\n\t\thistory.back();\n\t}\n\t\n\n})(window['NACSS']['viewer']);\n"]}